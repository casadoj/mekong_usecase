
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Calibration &#8212; LISFLOOD use cases</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '4_calibration';</script>
    <link rel="canonical" href="/lisflood-usecases/4_calibration.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Other use cases" href="5_other_usecases.html" />
    <link rel="prev" title="Main run" href="3_run.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="README.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/header.png" class="logo__image only-light" alt="LISFLOOD use cases - Home"/>
    <script>document.write(`<img src="_static/header.png" class="logo__image only-dark" alt="LISFLOOD use cases - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="0_general_setup.html">Input and general settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="1_initialization.html">Initialization run</a></li>
<li class="toctree-l1"><a class="reference internal" href="2_warmup.html">Warmup run</a></li>
<li class="toctree-l1"><a class="reference internal" href="3_run.html">Main run</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Calibration</a></li>
<li class="toctree-l1"><a class="reference internal" href="5_other_usecases.html">Other use cases</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/4_calibration.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Calibration</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#settings-file">1 Settings file</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#initialization">2 Initialization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#warmup">3 Warmup</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#end-maps">3.1 End maps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lower-groundwater-zone">3.2 Lower groundwater zone</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run">4 Run</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><img alt="header" src="_images/header.png" /></p>
<section class="tex2jax_ignore mathjax_ignore" id="calibration">
<h1>Calibration<a class="headerlink" href="#calibration" title="Link to this heading">#</a></h1>
<!-- [![Binder](https://mybinder.org/badge_logo.svg)](https://mybinder.org/v2/gh/ec-jrc/lisflood-usecases/mekong_usecase?urlpath=%2Fdoc%2Ftree%2FLF_mekong_usecase%2Fdocs%2Fnotebooks%2F) -->
<br>
<br>
<br>
<p>So far, we have developed a LISFLOOD model than runs and it is correctly initialized. However, we are using default model parameters, so there’s no confidence at all in the accuracy of the model. Before you can extract any conclusions from your model results, the model needs to be calibrated. As a result of the calibration, the model parameters are tuned so that the outputs reproduce observed data as good as possible. Calibration is usually performed on the river discharge timeseries at one or more gauging stations, but there are plenty of other calibration strategies.</p>
<p>To perform a calibration, LISFLOOD proposes a <a class="reference external" href="https://github.com/ec-jrc/lisflood-calibration">calibration tool</a> based on DEAP (Distributed Evolutionary Algorithms in Python) (<a class="reference external" href="https://www.jmlr.org/papers/volume13/fortin12a/fortin12a.pdf">Fortin et al., 2012</a>). The calibration procedure exceeds the scope of this tutorial, so we will not get into it. Please, feel free to use any other calibration procedure or optimization algorithm.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">lisflood_read_plot</span><span class="w"> </span><span class="kn">import</span> <span class="n">read_tss</span>

<span class="n">path_model</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s1">&#39;../LF_mekong_usecase&#39;</span><span class="p">)</span>
<span class="n">path_init</span> <span class="o">=</span> <span class="n">path_model</span> <span class="o">/</span> <span class="s1">&#39;results&#39;</span> <span class="o">/</span> <span class="s1">&#39;initial&#39;</span>
<span class="n">path_warmup</span> <span class="o">=</span> <span class="n">path_model</span> <span class="o">/</span> <span class="s1">&#39;results&#39;</span> <span class="o">/</span> <span class="s1">&#39;warmup&#39;</span>
<span class="n">path_run</span> <span class="o">=</span> <span class="n">path_model</span> <span class="o">/</span> <span class="s1">&#39;results&#39;</span> <span class="o">/</span> <span class="s1">&#39;run&#39;</span>
</pre></div>
</div>
</div>
</div>
<section id="settings-file">
<h2>1 Settings file<a class="headerlink" href="#settings-file" title="Link to this heading">#</a></h2>
<p>The repository includes three settings files (one for each of the runs) in which we have changed the calibration parameters according to the results of the calibration of the model (<code class="docutils literal notranslate"><span class="pre">lfuser</span></code> section in the settings file). Apart from the calibration parameters, we have changed the output directories, so the results won’t overwrite those of the previous runs. The results will be saved in subdirectories called <code class="docutils literal notranslate"><span class="pre">calibrated</span></code>; for instance, the initial conditions will be saved in the folder <code class="docutils literal notranslate"><span class="pre">initial/calibrated</span></code> instead of the folder <code class="docutils literal notranslate"><span class="pre">initial</span></code>.</p>
<p>The snippet below shows a part of the file <a class="reference download internal" download="" href="_downloads/e30cd77fa8b577e6b4016820fefede5d/settings_calibrated_run.xml"><span class="xref download myst"><em>settings_calibrated_run.xml</em></span></a> that is used to run the final simulation of 30 years using calibrated parameters. It defines the paths to the initial conditions and where results will be saved, and the definition of the calibrated parameters.</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;lfuser&gt;</span>
<span class="w">    </span>
<span class="w">    </span>[...]
<span class="w">    </span>
<span class="w">    </span><span class="cm">&lt;!--</span>
<span class="cm">    **************************************************************</span>
<span class="cm">    FILE PATHS</span>
<span class="cm">    **************************************************************</span>
<span class="cm">    --&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;PathInit&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;$(PathRoot)/results/initial/calibrated&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;PathWarm&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;$(PathRoot)/results/warmup/calibrated&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;PathOut&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;$(PathRoot)/results/run/calibrated&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span>
<span class="w">    </span><span class="cm">&lt;!--</span>
<span class="cm">    **************************************************************</span>
<span class="cm">    CALIBRATION PARAMETERS</span>
<span class="cm">    **************************************************************</span>
<span class="cm">    --&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;UpperZoneTimeConstant&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;7.47476&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;LowerZoneTimeConstant&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;153.604&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;GwPercValue&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;1.643&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;GwLoss&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;0.501192&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;LZThreshold&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;16.1032&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;b_Xinanjiang&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;0.215152&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;PowerPrefFlow&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;2.51033&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;CalChanMan&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;1.8149&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;CalChanMan2&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;5&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;SnowMeltCoef&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;2.55434&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;LakeMultiplier&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;0.875565&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;adjust_Normal_Flood&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;0.49691&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ReservoirRnormqMult&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;1.30807&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;AvWaterRateThreshold&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;5.0&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;QSplitMult&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;1.99051&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ChanBottomWMult&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;1.0&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ChanDepthTMult&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;1.0&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;textvar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;ChanSMult&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;1.0&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span>
<span class="w">    </span>[...]
<span class="w">    </span>
<span class="nt">&lt;/lfuser&gt;</span>
</pre></div>
</div>
</section>
<section id="initialization">
<h2>2 Initialization<a class="headerlink" href="#initialization" title="Link to this heading">#</a></h2>
<p>As explained in <a class="reference internal" href="1_initialization.html"><span class="std std-doc">Chapter 1 - Initialization</span></a>, this run is meant to create two outmaps that define the average river discharge (<code class="docutils literal notranslate"><span class="pre">avgdis.nc</span></code>) and the average inflow into the lower groundwater zone (<code class="docutils literal notranslate"><span class="pre">lzavin.nc</span></code>).</p>
<p>To run this simulation, open a terminal, activate the Conda environment where you have installed LISFLOOD and execute <code class="docutils literal notranslate"><span class="pre">lisflood</span></code> pointing at the appropriate settings file.</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>activate<span class="w"> </span>&lt;your_lisflood_environment&gt;
<span class="nb">cd</span><span class="w"> </span>&lt;path_where_you_saved_the_repository&gt;/lisflood-usecases
lisflood<span class="w"> </span>LF_mekong_usecase/settings_calibrated_initialization.xml
</pre></div>
</div>
<p>Let’s see how these initialization maps change once we apply the calibration parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>

<span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">cmap</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;lzavin&#39;</span><span class="p">,</span> <span class="s1">&#39;avgdis&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="s1">&#39;Greens&#39;</span><span class="p">])):</span>
    <span class="n">non_calib</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataarray</span><span class="p">(</span><span class="n">path_init</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1">.nc&#39;</span><span class="p">)</span>
    <span class="n">non_calib</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">calib</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataarray</span><span class="p">(</span><span class="n">path_init</span> <span class="o">/</span> <span class="s1">&#39;calibrated&#39;</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1">.nc&#39;</span><span class="p">)</span>
    <span class="n">calib</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    
    <span class="n">vmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">non_calib</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">calib</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
    <span class="n">vmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">non_calib</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">calib</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    
    <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">da</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">non_calib</span><span class="p">,</span> <span class="n">calib</span><span class="p">]):</span>
        <span class="n">da</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">r</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">.275</span><span class="p">,</span> <span class="mf">.9</span><span class="p">,</span> <span class="s1">&#39;Uncalibrated&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">.7</span><span class="p">,</span> <span class="mf">.9</span><span class="p">,</span> <span class="s1">&#39;Calibrated&#39;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ValueError</span><span class="g g-Whitespace">                                </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">line</span> <span class="mi">4</span>
<span class="g g-Whitespace">      </span><span class="mi">1</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">9</span><span class="p">))</span>
<span class="g g-Whitespace">      </span><span class="mi">3</span> <span class="k">for</span> <span class="n">r</span><span class="p">,</span> <span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">cmap</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">([</span><span class="s1">&#39;lzavin&#39;</span><span class="p">,</span> <span class="s1">&#39;avgdis&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;Blues&#39;</span><span class="p">,</span> <span class="s1">&#39;Greens&#39;</span><span class="p">])):</span>
<span class="ne">----&gt; </span><span class="mi">4</span>     <span class="n">non_calib</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataarray</span><span class="p">(</span><span class="n">path_init</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1">.nc&#39;</span><span class="p">)</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="n">non_calib</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>     <span class="n">calib</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataarray</span><span class="p">(</span><span class="n">path_init</span> <span class="o">/</span> <span class="s1">&#39;calibrated&#39;</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1">.nc&#39;</span><span class="p">)</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/xarray/backends/api.py:881,</span> in <span class="ni">open_dataarray</span><span class="nt">(filename_or_obj, engine, chunks, cache, decode_cf, mask_and_scale, decode_times, decode_timedelta, use_cftime, concat_characters, decode_coords, drop_variables, inline_array, chunked_array_type, from_array_kwargs, backend_kwargs, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">710</span> <span class="k">def</span><span class="w"> </span><span class="nf">open_dataarray</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">711</span>     <span class="n">filename_or_obj</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="n">ReadBuffer</span> <span class="o">|</span> <span class="n">AbstractDataStore</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">712</span>     <span class="o">*</span><span class="p">,</span>
   <span class="p">(</span><span class="o">...</span><span class="p">)</span>    <span class="mi">731</span>     <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">732</span> <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataArray</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">733</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Open an DataArray from a file or file-like object containing a single</span>
<span class="g g-Whitespace">    </span><span class="mi">734</span><span class="sd">     data variable.</span>
<span class="g g-Whitespace">    </span><span class="mi">735</span><span class="sd"> </span>
<span class="sd">   (...)    878     open_dataset</span>
<span class="g g-Whitespace">    </span><span class="mi">879</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="ne">--&gt; </span><span class="mi">881</span>     <span class="n">dataset</span> <span class="o">=</span> <span class="n">open_dataset</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">882</span>         <span class="n">filename_or_obj</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">883</span>         <span class="n">decode_cf</span><span class="o">=</span><span class="n">decode_cf</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">884</span>         <span class="n">mask_and_scale</span><span class="o">=</span><span class="n">mask_and_scale</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">885</span>         <span class="n">decode_times</span><span class="o">=</span><span class="n">decode_times</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">886</span>         <span class="n">concat_characters</span><span class="o">=</span><span class="n">concat_characters</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">887</span>         <span class="n">decode_coords</span><span class="o">=</span><span class="n">decode_coords</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">888</span>         <span class="n">engine</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">889</span>         <span class="n">chunks</span><span class="o">=</span><span class="n">chunks</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">890</span>         <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">891</span>         <span class="n">drop_variables</span><span class="o">=</span><span class="n">drop_variables</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">892</span>         <span class="n">inline_array</span><span class="o">=</span><span class="n">inline_array</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">893</span>         <span class="n">chunked_array_type</span><span class="o">=</span><span class="n">chunked_array_type</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">894</span>         <span class="n">from_array_kwargs</span><span class="o">=</span><span class="n">from_array_kwargs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">895</span>         <span class="n">backend_kwargs</span><span class="o">=</span><span class="n">backend_kwargs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">896</span>         <span class="n">use_cftime</span><span class="o">=</span><span class="n">use_cftime</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">897</span>         <span class="n">decode_timedelta</span><span class="o">=</span><span class="n">decode_timedelta</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">898</span>         <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">899</span>     <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">901</span>     <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">data_vars</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">902</span>         <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">data_vars</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/xarray/backends/api.py:668,</span> in <span class="ni">open_dataset</span><span class="nt">(filename_or_obj, engine, chunks, cache, decode_cf, mask_and_scale, decode_times, decode_timedelta, use_cftime, concat_characters, decode_coords, drop_variables, inline_array, chunked_array_type, from_array_kwargs, backend_kwargs, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">665</span>     <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">backend_kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">667</span> <span class="k">if</span> <span class="n">engine</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">668</span>     <span class="n">engine</span> <span class="o">=</span> <span class="n">plugins</span><span class="o">.</span><span class="n">guess_engine</span><span class="p">(</span><span class="n">filename_or_obj</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">670</span> <span class="k">if</span> <span class="n">from_array_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">671</span>     <span class="n">from_array_kwargs</span> <span class="o">=</span> <span class="p">{}</span>

<span class="nn">File /opt/hostedtoolcache/Python/3.11.13/x64/lib/python3.11/site-packages/xarray/backends/plugins.py:194,</span> in <span class="ni">guess_engine</span><span class="nt">(store_spec)</span>
<span class="g g-Whitespace">    </span><span class="mi">186</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">187</span>     <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">188</span>         <span class="s2">&quot;found the following matches with the input file in xarray&#39;s IO &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">189</span>         <span class="sa">f</span><span class="s2">&quot;backends: </span><span class="si">{</span><span class="n">compatible_engines</span><span class="si">}</span><span class="s2">. But their dependencies may not be installed, see:</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">190</span>         <span class="s2">&quot;https://docs.xarray.dev/en/stable/user-guide/io.html </span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">191</span>         <span class="s2">&quot;https://docs.xarray.dev/en/stable/getting-started-guide/installing.html&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">192</span>     <span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">194</span> <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>

<span class="ne">ValueError</span>: did not find a match in any of xarray&#39;s currently installed IO backends [&#39;netcdf4&#39;]. Consider explicitly selecting one of the installed engines via the ``engine`` parameter, or installing additional IO dependencies, see:
<span class="ne">https</span>://docs.xarray.dev/en/stable/getting-started-guide/installing.html
<span class="ne">https</span>://docs.xarray.dev/en/stable/user-guide/io.html
</pre></div>
</div>
<img alt="_images/834194c0c41ef93401db2a94bdb555e661db418ff165b77fa9a2b351f6ba297a.png" src="_images/834194c0c41ef93401db2a94bdb555e661db418ff165b77fa9a2b351f6ba297a.png" />
</div>
</div>
<p><em><strong>Figure 1</strong>. Output maps from the initialization run: average inflow into the lower groundwater zone (LZAvin) and average river discharge (avgdis). The left column corresponds to the initialization with default parameters, and the right column to the initialization with calibrated parameters.</em></p>
<p>In our study case, the change in the <em>lzavin</em> is notorious.</p>
</section>
<section id="warmup">
<h2>3 Warmup<a class="headerlink" href="#warmup" title="Link to this heading">#</a></h2>
<p>As explained in <a class="reference internal" href="2_warmup.html"><span class="std std-doc">Chapter 3 - Warmup</span></a>, the objective of this run is to find the initial conditions at the begining of the target run. The usual output of these simulation is a set of maps (NetCDF) with the model state variables at the end of the simulation. For educational purposes, we chose to write, not only the end state maps, but also the map stack of one of the state variables: the lower groundwater zone.</p>
<p>To run this simulation, open a terminal and follow these steps:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>activate<span class="w"> </span>&lt;your_lisflood_environment&gt;
<span class="nb">cd</span><span class="w"> </span>&lt;path_where_you_saved_the_repository&gt;/lisflood-usecases
lisflood<span class="w"> </span>LF_mekong_usecase/settings_calibrated_warmup.xml
</pre></div>
</div>
<p>Let’s see how some of the outputs of this run have changed with the calibrated parameters and the new initialization maps.</p>
<section id="end-maps">
<h3>3.1 End maps<a class="headerlink" href="#end-maps" title="Link to this heading">#</a></h3>
<p>The following figure compares the end state maps of the warmup run with default parameters (<em>uncalibrated</em>) and the run with calibrated parameters (<em>calibrated</em>). Only five state variables are shown, the three soil layers (blue) and the two groundwater zones (green).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load some end state maps (initial conditions for the run)</span>
<span class="n">init_cond</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;uncalibrated&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;calibrated&#39;</span><span class="p">:</span> <span class="p">{}}</span>
<span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
<span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;tha&#39;</span><span class="p">,</span> <span class="s1">&#39;thb&#39;</span><span class="p">,</span> <span class="s1">&#39;thc&#39;</span><span class="p">,</span> <span class="s1">&#39;uz&#39;</span><span class="p">,</span> <span class="s1">&#39;lz&#39;</span><span class="p">]:</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataarray</span><span class="p">(</span><span class="n">path_warmup</span> <span class="o">/</span>  <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1">_end.nc&#39;</span><span class="p">)</span>
    <span class="n">da</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">init_cond</span><span class="p">[</span><span class="s1">&#39;uncalibrated&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">da</span>
    <span class="n">da</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataarray</span><span class="p">(</span><span class="n">path_warmup</span> <span class="o">/</span> <span class="s1">&#39;calibrated&#39;</span> <span class="o">/</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s1">_end.nc&#39;</span><span class="p">)</span>
    <span class="n">da</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">init_cond</span><span class="p">[</span><span class="s1">&#39;calibrated&#39;</span><span class="p">][</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">da</span>

<span class="c1"># plot end state maps</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nrows</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">))</span>
<span class="n">plot_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;soil&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;vars&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;tha&#39;</span><span class="p">,</span> <span class="s1">&#39;thb&#39;</span><span class="p">,</span> <span class="s1">&#39;thc&#39;</span><span class="p">],</span> 
        <span class="s1">&#39;cmap&#39;</span><span class="p">:</span> <span class="s1">&#39;Blues&#39;</span>
    <span class="p">},</span>
    <span class="s1">&#39;groudwater&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;vars&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;uz&#39;</span><span class="p">,</span> <span class="s1">&#39;lz&#39;</span><span class="p">],</span> 
        <span class="s1">&#39;cmap&#39;</span><span class="p">:</span> <span class="s1">&#39;Greens&#39;</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">for</span> <span class="n">g</span><span class="p">,</span> <span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">plot_config</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;vars&#39;</span><span class="p">]):</span>
        <span class="c1"># calculate minimum and maximum values for the colorbar</span>
        <span class="n">vmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">init_cond</span><span class="p">[</span><span class="n">sim</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="k">for</span> <span class="n">sim</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;uncalibrated&#39;</span><span class="p">,</span> <span class="s1">&#39;calibrated&#39;</span><span class="p">]])</span>
        <span class="n">vmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">init_cond</span><span class="p">[</span><span class="n">sim</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="k">for</span> <span class="n">sim</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;uncalibrated&#39;</span><span class="p">,</span> <span class="s1">&#39;calibrated&#39;</span><span class="p">]])</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">sim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="s1">&#39;uncalibrated&#39;</span><span class="p">,</span> <span class="s1">&#39;calibrated&#39;</span><span class="p">]):</span>
            <span class="c1"># plot the map</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">g</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">s</span>
            <span class="n">init_cond</span><span class="p">[</span><span class="n">sim</span><span class="p">][</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">],</span> 
                <span class="n">cmap</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;cmap&#39;</span><span class="p">],</span> 
                <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span> 
                <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                <span class="n">cbar_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;shrink&#39;</span><span class="p">:</span> <span class="mf">0.8</span><span class="p">},</span>
            <span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">col</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">col</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                    <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
            <span class="c1"># add title to each row</span>
            <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fig</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="mf">.08</span><span class="p">,</span> <span class="mf">.8</span> <span class="o">-</span> <span class="mf">.2</span> <span class="o">*</span> <span class="n">row</span><span class="p">,</span> <span class="n">sim</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ee3a0967600ed0d439f27e93232e403005a2fdb670fff933e1a698a4340f3eb3.png" src="_images/ee3a0967600ed0d439f27e93232e403005a2fdb670fff933e1a698a4340f3eb3.png" />
</div>
</div>
<p><em><strong>Figure 2</strong>. Initial conditions in the soil (blue) and groundwater (green) layers. In each of the groups of variables, the top row corresponds to the initial conditions with default parameters, and the bottom row to the initial conditions with calibrated parameters.</em></p>
<p>In our study case, the initial conditions of the soil layers have not changed significantly, but those of the groundwater zone are clearly different.</p>
</section>
<section id="lower-groundwater-zone">
<h3>3.2 Lower groundwater zone<a class="headerlink" href="#lower-groundwater-zone" title="Link to this heading">#</a></h3>
<p>In the previous figure we saw that the state of the lower groundwater zone is very different with the new calibrated warmup run. Since we have created the map stack for this variable, we can dig deeper into the differences between this warmup run with calibrated parameters and the the previous warmup run with default parameters.</p>
<p>The following figure shows the timeseries of the average lower groundwater storage (catchment mean) in both warmup runs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># load map stack for the uncalibrated warmup</span>
<span class="n">lz</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataarray</span><span class="p">(</span><span class="n">path_warmup</span> <span class="o">/</span> <span class="s1">&#39;lz.nc&#39;</span><span class="p">)</span>
<span class="n">lz</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># load map stack for the calibrated warmup</span>
<span class="n">lz_cal</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataarray</span><span class="p">(</span><span class="n">path_warmup</span> <span class="o">/</span> <span class="s1">&#39;calibrated&#39;</span> <span class="o">/</span> <span class="s1">&#39;lz.nc&#39;</span><span class="p">)</span>
<span class="n">lz_cal</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c1"># plot comparison</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">lz</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;uncalibrated&#39;</span><span class="p">)</span>
<span class="n">lz_cal</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="s1">&#39;lon&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;calibrated&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
    <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="n">lz</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">lz</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
    <span class="n">xlabel</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">),</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;lower groundwater [mm]&#39;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">[</span><span class="mf">0.45</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.07</span><span class="p">,</span> <span class="mf">.1</span><span class="p">,</span> <span class="mf">.1</span><span class="p">],</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/ac1796411faeac65c9d5a48ce24ba87804ff8fc79ef92367a509691597597fbb.png" src="_images/ac1796411faeac65c9d5a48ce24ba87804ff8fc79ef92367a509691597597fbb.png" />
</div>
</div>
<p><em><strong>Figure 3</strong>. Evolution of the amount of water stored in the lower groundwater zone during the warmup run.</em></p>
</section>
</section>
<section id="run">
<h2>4 Run<a class="headerlink" href="#run" title="Link to this heading">#</a></h2>
<p>The previous figures were meant only to explain why the initialization and warmup simulations need to be rerun with the new calibrated parameters. If we didn’t, neither the initialization maps nor the initial conditions would correspond to the behaviour of the calibrated model, which would cause a strange model output at the beginning of the target run.</p>
<p>Now we are in a position to run our target simulation with a correct initialization and a calibrated model. To do so, open a terminal a follow these steps:</p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>activate<span class="w"> </span>&lt;your_lisflood_environment&gt;
<span class="nb">cd</span><span class="w"> </span>&lt;path_where_you_saved_the_repository&gt;/lisflood-usecases
lisflood<span class="w"> </span>LF_mekong_usecase/settings_calibrated_run.xml
</pre></div>
</div>
<p>The following figure compares the discharge simulated at the catchment outlet by both the uncalibrated and the calibrated models.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># settings files for the main run with default or calibrated parameters</span>
<span class="n">settings</span> <span class="o">=</span> <span class="n">path_model</span> <span class="o">/</span> <span class="s1">&#39;settings_run.xml&#39;</span>
<span class="n">settings_cal</span> <span class="o">=</span> <span class="n">path_model</span> <span class="o">/</span> <span class="s1">&#39;settings_calibrated_run.xml&#39;</span>

<span class="c1"># import non-calibrated discharge timeseries</span>
<span class="n">dis</span> <span class="o">=</span> <span class="n">read_tss</span><span class="p">(</span><span class="n">path_run</span> <span class="o">/</span> <span class="s1">&#39;disWin.tss&#39;</span><span class="p">,</span> <span class="n">xml</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>

<span class="c1"># import calibrated discharge timeseries</span>
<span class="n">dis_cal</span> <span class="o">=</span> <span class="n">read_tss</span><span class="p">(</span><span class="n">path_run</span> <span class="o">/</span> <span class="s1">&#39;calibrated&#39;</span> <span class="o">/</span> <span class="s1">&#39;disWin.tss&#39;</span><span class="p">,</span> <span class="n">xml</span><span class="o">=</span><span class="n">settings_cal</span><span class="p">)</span>

<span class="c1"># plot timeseries</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dis</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mf">.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;uncalibrated&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dis_cal</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">lw</span><span class="o">=</span><span class="mf">.7</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;calibrated&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
    <span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2010</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span>
    <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">200</span><span class="p">,</span> <span class="mi">4200</span><span class="p">),</span>
    <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;discharge [m3/s]&#39;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">[</span><span class="mf">0.45</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">.1</span><span class="p">,</span> <span class="mf">.1</span><span class="p">],</span> <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/6a8a849e939895a72c8e77bb955dee33d8c277393c416c0e75af205d2fb7b857.png" src="_images/6a8a849e939895a72c8e77bb955dee33d8c277393c416c0e75af205d2fb7b857.png" />
</div>
</div>
<p><em><strong>Figure 4</strong>. River discharge at the catchment outlet with default (blue) or calibrated (orange) parameters.</em></p>
<p>As we see, the results differ when we run the calibrated model. These differences may seem small in our case study, but it is extremely important to calibrate the model before extracting any conclusions from the model results.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="3_run.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Main run</p>
      </div>
    </a>
    <a class="right-next"
       href="5_other_usecases.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Other use cases</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#settings-file">1 Settings file</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#initialization">2 Initialization</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#warmup">3 Warmup</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#end-maps">3.1 End maps</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lower-groundwater-zone">3.2 Lower groundwater zone</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#run">4 Run</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Joint Research Center - European Commission
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>